<div class="container mx-auto p-4">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Services Management</h1>
    <button (click)="toggleServicesSection()" class="btn btn-sm btn-outline">
      {{ servicesSectionOpen ? 'Collapse' : 'Expand' }}
    </button>
  </div>

  <div *ngIf="servicesSectionOpen">
    <div class="mb-8 p-4 border rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Create New Service</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="label">
            <span class="label-text">Tag</span>
          </label>
          <input type="text" [(ngModel)]="newService.tag" placeholder="Service Tag" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label">
            <span class="label-text">Value</span>
          </label>
          <input type="text" [(ngModel)]="newService.value" placeholder="Service Value" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label">
            <span class="label-text">Business Type</span>
          </label>
          <select [(ngModel)]="newService.businessType" class="select select-bordered w-full">
            <option *ngFor="let type of businessTypes" [ngValue]="type">{{ type }}</option>
          </select>
        </div>
      </div>
      <button (click)="createService()" class="btn btn-primary mt-4">Create Service</button>
    </div>

    <div *ngIf="editingService" class="mb-8 p-4 border rounded-lg shadow bg-base-200">
      <h2 class="text-xl font-semibold mb-2">Edit Service: {{ editingService.tag }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="label">
            <span class="label-text">Tag</span>
          </label>
          <input type="text" [(ngModel)]="editingService.tag" placeholder="Service Tag" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label">
            <span class="label-text">Value</span>
          </label>
          <input type="text" [(ngModel)]="editingService.value" placeholder="Service Value" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label">
            <span class="label-text">Business Type</span>
          </label>
          <select [(ngModel)]="editingService.businessType" class="select select-bordered w-full">
            <option *ngFor="let type of businessTypes" [ngValue]="type">{{ type }}</option>
          </select>
        </div>
      </div>
      <div class="mt-4">
        <button (click)="updateService()" class="btn btn-primary mr-2">Update Service</button>
        <button (click)="cancelEdit()" class="btn btn-ghost">Cancel</button>
      </div>
    </div>

    <div class="overflow-x-auto mb-8">
      <h2 class="text-xl font-semibold mb-2">Existing Services</h2>
      <table class="table w-full table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>Tag</th>
            <th>Value</th>
            <th>Business Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let service of services">
            <td>{{ service.id }}</td>
            <td>{{ service.tag }}</td>
            <td>{{ service.value }}</td>
            <td>{{ service.businessType }}</td>
            <td>
              <button (click)="editService(service)" class="btn btn-sm btn-outline btn-info mr-2">Edit</button>
              <button (click)="deleteService(service.id)" class="btn btn-sm btn-outline btn-error">Delete</button>
            </td>
          </tr>
          <tr *ngIf="services.length === 0">
            <td colspan="5" class="text-center">No services found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Business Management Section -->
  <hr class="my-8 border-t-2 border-gray-300">

  <div class="flex justify-between items-center mb-4 mt-8">
    <h1 class="text-2xl font-bold">Business Management</h1>
    <button (click)="toggleBusinessesSection()" class="btn btn-sm btn-outline">
      {{ businessesSectionOpen ? 'Collapse' : 'Expand' }}
    </button>
  </div>

  <div *ngIf="businessesSectionOpen">
    <div class="mb-8 p-4 border rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Create New Business</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label"><span class="label-text">Name</span></label>
          <input type="text" [(ngModel)]="newBusiness.name" placeholder="Business Name" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Address</span></label>
          <input type="text" [(ngModel)]="newBusiness.address" placeholder="Address" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Phone Number</span></label>
          <input type="text" [(ngModel)]="newBusiness.phoneNumber" placeholder="Phone Number" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Email</span></label>
          <input type="email" [(ngModel)]="newBusiness.email" placeholder="Email" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Website URL</span></label>
          <input type="url" [(ngModel)]="newBusiness.websiteUrl" placeholder="Website URL" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Business Type</span></label>
          <select [(ngModel)]="newBusiness.businessType" class="select select-bordered w-full">
            <option *ngFor="let type of businessTypes" [ngValue]="type">{{ type }}</option>
          </select>
        </div>
      </div>
      <button (click)="createBusiness()" class="btn btn-primary mt-4">Create Business</button>
    </div>

    <div *ngIf="editingBusiness" class="mb-8 p-4 border rounded-lg shadow bg-base-200">
      <h2 class="text-xl font-semibold mb-2">Edit Business: {{ editingBusiness.name }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label"><span class="label-text">Name</span></label>
          <input type="text" [(ngModel)]="editingBusiness.name" placeholder="Business Name" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Address</span></label>
          <input type="text" [(ngModel)]="editingBusiness.address" placeholder="Address" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Phone Number</span></label>
          <input type="text" [(ngModel)]="editingBusiness.phoneNumber" placeholder="Phone Number" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Email</span></label>
          <input type="email" [(ngModel)]="editingBusiness.email" placeholder="Email" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Website URL</span></label>
          <input type="url" [(ngModel)]="editingBusiness.websiteUrl" placeholder="Website URL" class="input input-bordered w-full" />
        </div>
        <div>
          <label class="label"><span class="label-text">Business Type</span></label>
          <select [(ngModel)]="editingBusiness.businessType" class="select select-bordered w-full">
            <option *ngFor="let type of businessTypes" [ngValue]="type">{{ type }}</option>
          </select>
        </div>
      </div>
      <div class="mt-4">
        <button (click)="updateBusiness()" class="btn btn-primary mr-2">Update Business</button>
        <button (click)="cancelEditBusiness()" class="btn btn-ghost">Cancel</button>
      </div>
    </div>

    <div class="overflow-x-auto">
      <h2 class="text-xl font-semibold mb-2">Existing Businesses</h2>
      <table class="table w-full table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Address</th>
            <th>Phone</th>
            <th>Email</th>
            <th>Website</th>
            <th>Type</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let business of businesses">
            <td>{{ business.id }}</td>
            <td>{{ business.name }}</td>
            <td>{{ business.address }}</td>
            <td>{{ business.phoneNumber }}</td>
            <td>{{ business.email }}</td>
            <td><a [href]="business.websiteUrl" target="_blank" class="link link-hover">{{ business.websiteUrl }}</a></td>
            <td>{{ business.businessType }}</td>
            <td>
              <button (click)="editBusiness(business)" class="btn btn-sm btn-outline btn-info mr-2">Edit</button>
              <button (click)="deleteBusiness(business.id)" class="btn btn-sm btn-outline btn-error">Delete</button>
            </td>
          </tr>
          <tr *ngIf="businesses.length === 0">
            <td colspan="8" class="text-center">No businesses found.</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Business Services Management Section -->
  <hr class="my-8 border-t-2 border-gray-300">

  <div class="flex justify-between items-center mb-4 mt-8">
    <h1 class="text-2xl font-bold">Business Services Management</h1>
    <button (click)="toggleBusinessServicesSection()" class="btn btn-sm btn-outline">
      {{ businessServicesSectionOpen ? 'Collapse' : 'Expand' }}
    </button>
  </div>

  <div *ngIf="businessServicesSectionOpen">
    <!-- Business Selection Dropdown -->
    <div class="mb-4 p-4 border rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Select Business</h2>
      <label class="label"><span class="label-text">Business</span></label>
      <select [(ngModel)]="selectedBusinessIdForServices" (change)="onBusinessSelectedForServices($event)" class="select select-bordered w-full">
        <option value="">-- Select a Business --</option>
        <option *ngFor="let business of allBusinessesForDropdown" [value]="business.id">{{ business.name }}</option>
      </select>
    </div>

    <div *ngIf="!selectedBusinessIdForServices && businessServicesSectionOpen" class="text-center p-4 text-gray-500">
      Please select a business to view or manage its services.
    </div>

    <div *ngIf="selectedBusinessIdForServices">
      <!-- Button to toggle Create Business Service Form -->
      <div class="my-4">
        <button (click)="toggleCreateBusinessServiceForm()" class="btn btn-primary" [disabled]="!selectedBusinessIdForServices">
          {{ showCreateBusinessServiceForm ? 'Cancel Adding Service' : 'Add New Business Service' }}
        </button>
      </div>

      <!-- Create New Business Service Form -->
      <div *ngIf="showCreateBusinessServiceForm" class="mb-8 p-4 border rounded-lg shadow bg-base-200">
        <h2 class="text-xl font-semibold mb-2">Create New Business Service</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="label"><span class="label-text">Service ID (Existing Generic Service ID)</span></label>
            <input type="text" [(ngModel)]="newBusinessService.serviceId" placeholder="Generic Service ID" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label"><span class="label-text">Price</span></label>
            <input type="number" [(ngModel)]="newBusinessService.price" placeholder="Price" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label"><span class="label-text">Duration (Minutes)</span></label>
            <input type="number" [(ngModel)]="newBusinessService.duration" placeholder="Duration" class="input input-bordered w-full" />
          </div>
        </div>
        <div class="mt-4">
          <button (click)="createBusinessService()" class="btn btn-primary mr-2">Save Service</button>
          <button (click)="cancelCreateBusinessService()" class="btn btn-ghost">Cancel</button>
        </div>
      </div>

      <!-- Edit Business Service Form -->
      <div *ngIf="editingBusinessService" class="mb-8 p-4 border rounded-lg shadow bg-base-200">
        <h2 class="text-xl font-semibold mb-2">Edit Business Service</h2>
         <!-- Display Service ID (read-only as it's part of key) -->
        <div>
          <label class="label"><span class="label-text">Service ID (Read-only)</span></label>
          <input type="text" [ngModel]="editingBusinessService.id" placeholder="Service ID" class="input input-bordered w-full" disabled />
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-2">
          <div>
            <label class="label"><span class="label-text">Price</span></label>
            <input type="number" [(ngModel)]="editingBusinessService.price" placeholder="Price" class="input input-bordered w-full" />
          </div>
          <div>
            <label class="label"><span class="label-text">Duration (Minutes)</span></label>
            <input type="number" [(ngModel)]="editingBusinessService.duration" placeholder="Duration" class="input input-bordered w-full" />
          </div>
        </div>
        <div class="mt-4">
          <button (click)="updateBusinessService()" class="btn btn-primary mr-2">Update Service</button>
          <button (click)="cancelEditBusinessService()" class="btn btn-ghost">Cancel</button>
        </div>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="isLoadingBusinessServices" class="text-center p-4">
        <span class="loading loading-lg loading-spinner text-primary"></span>
        <p>Loading business services...</p>
      </div>

      <!-- Existing Business Services List -->
      <div *ngIf="!isLoadingBusinessServices && businessServicesForSelectedBusiness.length > 0 && selectedBusinessIdForServices" class="overflow-x-auto mb-8">
        <h2 class="text-xl font-semibold mb-2">Services for Selected Business</h2>
        <table class="table w-full table-zebra">
          <thead>
            <tr>
              <th>ID (BusinessService ID)</th>
              <th>Generic Service ID</th>
              <th>Price</th>
              <th>Duration (Mins)</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let bs of businessServicesForSelectedBusiness">
              <td>{{ bs.id }}</td>
              <td>{{ bs.serviceId }}</td>
              <td>{{ bs.price | currency }}</td>
              <td>{{ bs.duration }}</td>
              <td>
                <button (click)="editBusinessService(bs)" class="btn btn-sm btn-outline btn-info mr-2">Edit</button>
                <button (click)="deleteBusinessService(bs.id)" class="btn btn-sm btn-outline btn-error">Delete</button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Message if no services found -->
      <div *ngIf="!isLoadingBusinessServices && businessServicesForSelectedBusiness.length === 0 && selectedBusinessIdForServices" class="text-center p-4 text-gray-500">
        No business services found for this business. You can add new ones using the button above.
      </div>
    </div>
  </div>

  <!-- Booking Management Section -->
  <hr class="my-8 border-t-2 border-gray-300">

  <div class="flex justify-between items-center mb-4 mt-8">
    <h1 class="text-2xl font-bold">Booking Management & Scheduler</h1>
    <button (click)="toggleBookingsSection()" class="btn btn-sm btn-outline">
      {{ bookingsSectionOpen ? 'Collapse' : 'Expand' }}
    </button>
  </div>

  <div *ngIf="bookingsSectionOpen">
    <!-- Business Selection Dropdown -->
    <div class="mb-4 p-4 border rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Select Business to View Bookings</h2>
      <label class="label"><span class="label-text">Business</span></label>
      <select [(ngModel)]="selectedBusinessIdForBookings" (change)="onBusinessSelectedForBookings($event)" class="select select-bordered w-full">
        <option value="">-- Select a Business --</option>
        <option *ngFor="let business of allBusinessesForDropdown" [value]="business.id">{{ business.name }}</option>
      </select>
    </div>

    <div *ngIf="!selectedBusinessIdForBookings && bookingsSectionOpen" class="text-center p-4 text-gray-500">
      Please select a business to view its bookings.
    </div>

    <div *ngIf="selectedBusinessIdForBookings">
      <!-- Create Booking Button -->
      <div class="my-4">
        <button (click)="openCreateBookingModal()" class="btn btn-primary"
                [disabled]="!selectedBusinessIdForBookings || isLoadingBookings">
          Create New Booking
        </button>
      </div>

      <!-- View Toggle Buttons -->
      <div class="mb-4 flex justify-center space-x-2">
        <button (click)="setSchedulerView('Day')" class="btn" [class.btn-active]="schedulerView === 'Day'">Day</button>
        <button (click)="setSchedulerView('Week')" class="btn" [class.btn-active]="schedulerView === 'Week'">Week</button>
        <button (click)="setSchedulerView('Month')" class="btn" [class.btn-active]="schedulerView === 'Month'">Month</button>
      </div>

      <!-- Loading Indicator -->
      <div *ngIf="isLoadingBookings" class="text-center p-4">
        <span class="loading loading-lg loading-spinner text-primary"></span>
        <p>Loading bookings...</p>
      </div>

      <!-- Syncfusion Scheduler -->
      <div *ngIf="!isLoadingBookings && selectedBusinessIdForBookings">
        <ejs-schedule [height]="'650px'" [width]="'100%'"
                      [selectedDate]="currentSchedulerDate"
                      [currentView]="schedulerView"
                      [eventSettings]="schedulerEventSettings">
          <e-views>
            <e-view option="Day"></e-view>
            <e-view option="Week"></e-view>
            <e-view option="Month"></e-view>
            <!-- <e-view option="Agenda"></e-view> -->
          </e-views>
        </ejs-schedule>
      </div>

      <!-- Message if no bookings found -->
      <div *ngIf="!isLoadingBookings && bookingsForSelectedBusiness.length === 0 && selectedBusinessIdForBookings" class="text-center p-4 text-gray-500">
        No bookings found for this business.
      </div>
    </div>
  </div>
  <!-- End of Booking Management Section -->

  <!-- Create Booking Modal -->
  <dialog class="modal" [class.modal-open]="showCreateBookingModal">
    <div class="modal-box w-11/12 max-w-3xl">
      <form [formGroup]="createBookingForm" (ngSubmit)="onSubmitBooking()">
        <h3 class="font-bold text-lg mb-4">Create New Booking</h3>

        <!-- Business Service Dropdown -->
        <div class="form-control w-full mb-4">
          <label class="label"><span class="label-text">Service</span></label>
          <select formControlName="businessServiceId" class="select select-bordered w-full"
                  [class.select-error]="createBookingForm.controls['businessServiceId'].invalid && createBookingForm.controls['businessServiceId'].touched">
            <option value="" disabled>-- Select a Service --</option>
            <option *ngFor="let service of availableServicesForBooking" [value]="service.id">
              {{ service.service?.value || 'Unknown Service' }} ({{ service.duration }} mins) - {{ service.price | currency }}
            </option>
          </select>
          <div *ngIf="createBookingForm.controls['businessServiceId'].invalid && createBookingForm.controls['businessServiceId'].touched" class="label text-error text-xs">
            Service is required.
          </div>
        </div>

        <!-- Date and Time Pickers -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Booking Date</span></label>
            <ejs-datepicker formControlName="selectedDate"
                            [min]="minBookingDate"
                            (change)="onBookingDateChange($event)"
                            placeholder="Select a date"
                            [ngClass]="{'input-error': createBookingForm.controls['selectedDate'].invalid && createBookingForm.controls['selectedDate'].touched}">
            </ejs-datepicker>
            <div *ngIf="createBookingForm.controls['selectedDate'].invalid && createBookingForm.controls['selectedDate'].touched" class="label text-error text-xs">
              Date is required.
            </div>
          </div>
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Booking Time</span></label>
            <ejs-timepicker formControlName="selectedTime"
                            (change)="onBookingTimeChange($event)"
                            placeholder="Select a time" format="HH:mm" step="15"
                            [ngClass]="{'input-error': createBookingForm.controls['selectedTime'].invalid && createBookingForm.controls['selectedTime'].touched}">
            </ejs-timepicker>
            <div *ngIf="createBookingForm.controls['selectedTime'].invalid && createBookingForm.controls['selectedTime'].touched" class="label text-error text-xs">
              Time is required.
            </div>
          </div>
        </div>

        <!-- Customer Details -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-control w-full">
            <label class="label"><span class="label-text">First Name</span></label>
            <input type="text" formControlName="firstName" placeholder="First Name" class="input input-bordered w-full"
                   [class.input-error]="createBookingForm.controls['firstName'].invalid && createBookingForm.controls['firstName'].touched" />
            <div *ngIf="createBookingForm.controls['firstName'].invalid && createBookingForm.controls['firstName'].touched" class="label text-error text-xs">
              First name is required.
            </div>
          </div>
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Last Name</span></label>
            <input type="text" formControlName="lastName" placeholder="Last Name" class="input input-bordered w-full"
                   [class.input-error]="createBookingForm.controls['lastName'].invalid && createBookingForm.controls['lastName'].touched" />
            <div *ngIf="createBookingForm.controls['lastName'].invalid && createBookingForm.controls['lastName'].touched" class="label text-error text-xs">
              Last name is required.
            </div>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Email</span></label>
            <input type="email" formControlName="email" placeholder="Email" class="input input-bordered w-full"
                   [class.input-error]="createBookingForm.controls['email'].invalid && createBookingForm.controls['email'].touched" />
            <div *ngIf="createBookingForm.controls['email'].touched && createBookingForm.controls['email'].errors?.['required']" class="label text-error text-xs">
              Email is required.
            </div>
            <div *ngIf="createBookingForm.controls['email'].touched && createBookingForm.controls['email'].errors?.['email']" class="label text-error text-xs">
              Invalid email format.
            </div>
          </div>
          <div class="form-control w-full">
            <label class="label"><span class="label-text">Phone Number</span></label>
            <input type="tel" formControlName="phoneNumber" placeholder="Phone Number" class="input input-bordered w-full"
                   [class.input-error]="createBookingForm.controls['phoneNumber'].invalid && createBookingForm.controls['phoneNumber'].touched" />
            <div *ngIf="createBookingForm.controls['phoneNumber'].invalid && createBookingForm.controls['phoneNumber'].touched" class="label text-error text-xs">
              Phone number is required.
            </div>
          </div>
        </div>

        <!-- Employee Dropdown (Optional) -->
        <!-- Add similar structure if employee selection is implemented -->
        <!-- For now, it's just a placeholder in the form group -->

        <!-- Notes Textarea -->
        <div class="form-control w-full mb-4">
          <label class="label"><span class="label-text">Notes (Optional)</span></label>
          <textarea formControlName="notes" class="textarea textarea-bordered w-full" placeholder="Any special requests or notes..."></textarea>
        </div>

        <!-- Modal Actions -->
        <div class="modal-action">
          <button type="button" (click)="closeCreateBookingModal()" class="btn btn-ghost">Cancel</button>
          <button type="submit" class="btn btn-primary" [disabled]="createBookingForm.invalid || isSubmittingBooking">
            <span *ngIf="isSubmittingBooking" class="loading loading-spinner"></span>
            {{ isSubmittingBooking ? 'Submitting...' : 'Create Booking' }}
          </button>
        </div>
      </form>
    </div>
  </dialog>
</div>
