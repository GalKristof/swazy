<div class="p-4">
  <div class="flex justify-between items-center mb-4">
    <h2 class="text-2xl font-bold">Services</h2>
    <button class="btn btn-primary" (click)="openCreateModal()">
      + Create Service
    </button>
  </div>

  <div *ngIf="isLoading()" class="flex justify-center items-center h-64">
    <span class="loading loading-spinner loading-lg"></span>
  </div>

  <div *ngIf="!isLoading() && services().length === 0" class="alert alert-info">
    <span>No services found.</span>
  </div>

  <div *ngIf="!isLoading() && services().length > 0" class="overflow-x-auto">
    <table class="table table-zebra w-full">
      <thead>
        <tr>
          <th>Tag</th>
          <th>Business Type</th>
          <th>Name</th>
          <th>Usage</th>
          <th>Created</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let service of services()" class="hover:bg-base-200">
          <td class="cursor-pointer" (click)="openEditModal(service)"><span class="badge badge-outline">{{ service.tag }}</span></td>
          <td class="cursor-pointer" (click)="openEditModal(service)"><span class="badge">{{ service.businessType }}</span></td>
          <td class="cursor-pointer" (click)="openEditModal(service)">{{ service.value }}</td>
          <td class="cursor-pointer" (click)="openEditModal(service)">
            <span
              class="badge"
              [class.badge-success]="service.usageCount > 0"
              [class.badge-ghost]="service.usageCount === 0"
            >
              {{ service.usageCount }}
            </span>
          </td>
          <td class="cursor-pointer" (click)="openEditModal(service)">{{ service.createdAt | date:'short' }}</td>
          <td>
            <div class="flex gap-2">
              <button class="btn btn-sm btn-ghost" (click)="openEditModal(service); $event.stopPropagation()">
                Edit
              </button>
              <button
                class="btn btn-sm btn-error btn-ghost"
                (click)="deleteService(service); $event.stopPropagation()"
                [disabled]="service.usageCount >= 1"
                [title]="service.usageCount >= 1 ? 'Cannot delete service in use by businesses' : 'Delete service'"
              >
                Delete
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Modal -->
  <div *ngIf="showModal()" class="modal modal-open">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4">
        {{ isEditMode() ? 'Edit Service' : 'Create Service' }}
      </h3>

      <!-- Show usage info for existing services -->
      <div *ngIf="isEditMode() && currentService()" class="alert alert-info mb-4">
        <div>
          <span class="font-semibold">Usage:</span>
          <span *ngIf="currentService()!.usageCount === 0">Not used by any business</span>
          <span *ngIf="currentService()!.usageCount === 1">Used by 1 business</span>
          <span *ngIf="currentService()!.usageCount > 1">Used by {{ currentService()!.usageCount }} businesses</span>
        </div>
      </div>

      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">Tag</span>
        </label>
        <input
          type="text"
          placeholder="e.g., haircut"
          class="input input-bordered"
          [value]="formTag()"
          (input)="formTag.set($any($event.target).value)"
        />
      </div>

      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">Business Type</span>
        </label>
        <select
          class="select select-bordered"
          [value]="formBusinessType()"
          (change)="formBusinessType.set($any($event.target).value)"
        >
          <option *ngFor="let type of businessTypes" [value]="type">{{ type }}</option>
        </select>
      </div>

      <div class="form-control mb-4">
        <label class="label">
          <span class="label-text">Service Name</span>
        </label>
        <input
          type="text"
          placeholder="e.g., Haircut"
          class="input input-bordered"
          [value]="formValue()"
          (input)="formValue.set($any($event.target).value)"
        />
      </div>

      <div class="modal-action">
        <button class="btn" (click)="closeModal()">Cancel</button>
        <button class="btn btn-primary" (click)="saveService()">
          {{ isEditMode() ? 'Update' : 'Create' }}
        </button>
      </div>
    </div>
    <div class="modal-backdrop" (click)="closeModal()"></div>
  </div>
</div>
